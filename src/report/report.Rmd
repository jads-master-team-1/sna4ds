---
title: "Cohesion within the European Parliament: a social network analysis"
shorttitle: "Cohesion within the European Parliament"
author:
  - name: "Iona Donaldson (2064159)"
    affiliation: "1"
  - name: "Colette van Happen (2069244)"
    affiliation: "1"
  - name: "Olivier Spinnler (2007452)"
    affiliation: "1"
  - name: "Tom de Wildt (2068292)"
    affiliation: "1"
  - name: "Laurens Priem (1274328)"
    affiliation: "1"
  - name: "Bram Delisse (2065006)"
    affiliation: "1"
affiliation:
  - id: "1"
    institution: "Jheronimus Academy of Data Science"
keywords: "TODO: ADD KEYWORDS"
wordcount: "TODO: ADD WORDCOUNT"
bibliography: r-references.bib
toc: yes
toc_float: yes
floatsintext: no
figurelist: no
tablelist: no
footnotelist: no
linenumbers: no
mask: no
draft: no
documentclass: "apa6"
classoption: "man"
output:
  html_document:
    fig_caption: yes
    number_sections: no
  papaja::apa6_pdf:
    fig_captions: yes
    number_sections: no
---

```{r setup, include = FALSE}
library("papaja")
r_refs("r-references.bib")
```

```{r analysis-preferences, include = FALSE}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
```
```{r echo=FALSE}
# Common abbreviations:
# w: weighted
# uw: unweighted
# soc: sociological bill
# ind: industrial bill
# clim: climate
# nw: network object

# Add color attribute for parties
add_party_colors <- function(net) {
  igraph::V(net)$color <- "gray"
  igraph::V(net)$color <- ifelse(igraph::V(net)$party== "EPP", "blue", igraph::V(net)$color)
  igraph::V(net)$color <- ifelse(igraph::V(net)$party== "IDG", "blue4", igraph::V(net)$color)
  igraph::V(net)$color <- ifelse(igraph::V(net)$party== "S&D", "red", igraph::V(net)$color)
  igraph::V(net)$color <- ifelse(igraph::V(net)$party== "ECR", "dodgerblue3", igraph::V(net)$color)
  igraph::V(net)$color <- ifelse(igraph::V(net)$party== "REG", "yellow", igraph::V(net)$color)
  igraph::V(net)$color <- ifelse(igraph::V(net)$party== "Greens/EFA", "green", igraph::V(net)$color)
  igraph::V(net)$color <- ifelse(igraph::V(net)$party== "The Left", "red4", igraph::V(net)$color)
  igraph::V(net)$color <- ifelse(igraph::V(net)$party== "NI", "slategray4", igraph::V(net)$color)

  return(net)
}

# Create table with network statistics
tab_statistic <- function(net, caption) {
  cn <- c("Measurement", "Value")
  num_nodes <- c("Number of nodes",igraph::vcount(net))
  num_edges <- c("Number of edges",igraph::ecount(net))
  trans <- c("Transitivity", sprintf(igraph::transitivity(net), fmt = "%#.3f"))
  dens <- c("Graph density", sprintf(igraph::edge_density(net), fmt = "%#.3f"))
  avg_path <- c("Average path length", sprintf(igraph::mean_distance(net), fmt = "%#.3f"))
  diam <- c("Diameter", igraph::diameter(net))
  
  tab <- rbind(cn, num_nodes, num_edges, trans, dens, avg_path, diam)
  rownames(tab) <- NULL
  
  knitr::kable(tab, caption = caption)
}

# Create plot with network statistic
plot_statistic <- function(fun, edges, num_votes, xlab, ylab, title) {
  df <- data.frame(agreement = integer(), statistic = double())
  
  for (i in 0:num_votes) {
    edges_filter <- edges[edges[, "agreement"] > i, c("mep1", "mep2")]
    net_filter <- igraph::graph_from_data_frame(edges_filter, vertices = mep, directed = FALSE)
    stat_filter <- fun(net_filter)
    
    de <- list(agreement = i, statistic = stat_filter)
    df = rbind(df, de, stringsAsFactors = FALSE) 
  }
  
  plot(df, type = "l", col = "blue", xlab = xlab, ylab = ylab, main = title)
}

# Create plot with threshold value
plot_network_agreement <- function(edges, threshold, layout) {
  edges <- edges[edges[, "agreement"] >= threshold, c("mep1", "mep2")]
  
  # Create network
  net <- igraph::graph_from_data_frame(edges, vertices = mep, directed = FALSE)
  
  # Plot network
  net_isolates <- which(igraph::degree(net) == 0)
  net_visualization <- igraph::delete.vertices(net, net_isolates)
  net_visualization <- add_party_colors(net_visualization)
  
  plot(net_visualization,
       vertex.size = 4,
       edge.size = .4,
       vertex.label = NA,
       layout = layout,
       main = paste("Threshold:", threshold, ",", "Isolates:", length(net_isolates), sep=" "))
}

# Create plot with threshold percentage
plot_network_agreement_percent <- function(edges, percent_threshold, layout) {
  edges <- edges[edges[, "agreement_percent"] >= percent_threshold, c("mep1", "mep2")]
  
  # Create network
  net <- igraph::graph_from_data_frame(edges, vertices = mep, directed = FALSE)
  
  # Plot network
  net_isolates <- which(igraph::degree(net) == 0)
  net_visualization <- igraph::delete.vertices(net, net_isolates)
  net_visualization <- add_party_colors(net_visualization)
  
  plot(net_visualization,
       vertex.size = 4,
       edge.size = .4,
       vertex.label = NA,
       layout = layout,
       main = paste("Threshold:", percent_threshold, ",", "Isolates:", length(net_isolates), sep=" "))
}
```

```{r echo=FALSE}
# Load data
mep <- read.csv("../../data/MEP_data.csv", header = T, sep = ",")
edges_soc_clim <- read.csv("../../data/edges_for_against_social.csv", header = T, sep = ",")
edges_ind_clim <- read.csv("../../data/edges_for_against_industry.csv", header = T, sep = ",")

# Rename columns
colnames(mep) <- c("mep", "party", "country")
colnames(edges_soc_clim) <- c("mep1", "mep2", "agreement")
colnames(edges_ind_clim) <- c("mep1", "mep2", "agreement")

# Drop columns
mep <- mep[c("mep", "party", "country")]

# Create column
edges_soc_clim$agreement_percent <- round(edges_soc_clim$agreement / 44, digits = 2)
edges_ind_clim$agreement_percent <- round(edges_ind_clim$agreement / 16, digits = 2)
```

```{r echo=FALSE, warning=FALSE}
# Create weighted networks
w_edges_soc_clim <- edges_soc_clim[edges_soc_clim[, "agreement"] >= 1, c("mep1", "mep2")]
w_net_soc_clim <- igraph::graph_from_data_frame(w_edges_soc_clim, vertices = mep, directed = FALSE)
w_net_soc_clim  <- igraph::set_edge_attr(w_net_soc_clim , "weight", value = edges_soc_clim$agreement_percent)

w_edges_ind_clim <- edges_ind_clim[edges_ind_clim[, "agreement"] >= 1, c("mep1", "mep2")]
w_net_ind_clim <- igraph::graph_from_data_frame(w_edges_ind_clim, vertices = mep, directed = FALSE)
w_net_ind_clim  <- igraph::set_edge_attr(w_net_ind_clim , "weight", value = edges_ind_clim$agreement_percent)

u_edges_soc_clim <- edges_soc_clim[edges_soc_clim[, "agreement"] >= 1, c("mep1", "mep2")]
u_net_soc_clim <- igraph::graph_from_data_frame(w_edges_soc_clim, vertices = mep, directed = FALSE)

u_edges_ind_clim <- edges_ind_clim[edges_ind_clim[, "agreement"] >= 1, c("mep1", "mep2")]
u_net_ind_clim <- igraph::graph_from_data_frame(w_edges_ind_clim, vertices = mep, directed = FALSE)

# Create unweighted networks
uw_edges_soc_clim_35 <- edges_soc_clim[edges_soc_clim[, "agreement_percent"] >= 0.35, c("mep1", "mep2")]
uw_net_soc_clim_35 <- igraph::graph_from_data_frame(uw_edges_soc_clim_35, vertices = mep, directed = FALSE)

uw_edges_ind_clim_35 <- edges_ind_clim[edges_ind_clim[, "agreement_percent"] >= 0.35, c("mep1", "mep2")]
uw_net_ind_clim_35 <- igraph::graph_from_data_frame(uw_edges_ind_clim_35, vertices = mep, directed = FALSE)

uw_edges_soc_clim_95 <- edges_soc_clim[edges_soc_clim[, "agreement_percent"] >= 0.95, c("mep1", "mep2")]
uw_net_soc_clim_95 <- igraph::graph_from_data_frame(uw_edges_soc_clim_95, vertices = mep, directed = FALSE)

uw_edges_ind_clim_95 <- edges_ind_clim[edges_ind_clim[, "agreement_percent"] >= 0.95, c("mep1", "mep2")]
uw_net_ind_clim_95 <- igraph::graph_from_data_frame(uw_edges_ind_clim_95, vertices = mep, directed = FALSE)

uw_edges_soc_clim_100 <- edges_soc_clim[edges_soc_clim[, "agreement_percent"] >= 1.0, c("mep1", "mep2")]
uw_net_soc_clim_100 <- igraph::graph_from_data_frame(uw_edges_soc_clim_100, vertices = mep, directed = FALSE)

uw_edges_ind_clim_100 <- edges_ind_clim[edges_ind_clim[, "agreement_percent"] >= 1.0, c("mep1", "mep2")]
uw_net_ind_clim_100 <- igraph::graph_from_data_frame(uw_edges_ind_clim_100, vertices = mep, directed = FALSE)
```

```{r echo=FALSE}
# Convert weighted networks
w_net_soc_clim_nw <- intergraph::asNetwork(w_net_soc_clim)
w_net_ind_clim_nw <- intergraph::asNetwork(w_net_ind_clim)

# Convert unweighted networks
uw_net_soc_clim_35_nw <- intergraph::asNetwork(uw_net_soc_clim_35)
uw_net_ind_clim_35_nw <- intergraph::asNetwork(uw_net_ind_clim_35)
uw_net_soc_clim_95_nw <- intergraph::asNetwork(uw_net_soc_clim_95)
uw_net_ind_clim_95_nw <- intergraph::asNetwork(uw_net_ind_clim_95)
uw_net_soc_clim_100_nw <- intergraph::asNetwork(uw_net_soc_clim_100)
uw_net_ind_clim_100_nw <- intergraph::asNetwork(uw_net_ind_clim_100)
```

\newpage

## Executive Summary
<!--
Executive Summary Description (150 words) – 0.3 POINTS

Basically an Abstract.

Summarize the report. Write this as the very last thing.

What is the main topic you are addressing?

What are your research questions and hypotheses?  

What are your results and the main conclusion?
-->

This study aims to investigate the cohesion of agreement for voting of members of the European Parliament (MEPs). The research is conducted on two separate bills with multiple votes, a sociological climate bill and an industrial climate bill, voted on by the EP on May 18th 2021. Social network analysis models are used to answer two research questions. Firstly, QAP is used to find the correlation between the network from the sociological climate bill and the network from the industrial climate bill. Literature suggests that the MEPs voting behaviour is heavily influenced by their European groups, therefore it is expected that there is a high level of correlation between both bills. Secondly, an ERGM model is used to investigate the influence of nationality on the MEPs voting behaviour on the sociological climate bill. Combining findings from different studies, it is expected that there will be a high level of cohesion between MEPs of the same nationality. It is found that there is an association between how pairs of MEPs agreed on both bills. Furthermore, it is found that for the sociological climate bill there is an 84% chance that MEPs with the same nationality vote similarly.

\newpage

# 1. Introduction 
<!--
Introduction Description (about 1000 words) – 0.5 POINTS

Place your topic of choice within the existing literature and explain what you 
are going to address in this report and why.

*	What is the main topic that is going to be studied in this paper?

*	Why is it important?

*	What are the existing studies that address it already?

*	What are your questions and hypotheses? Why are they important? How are they 
connected to previous work or to a problem you raised?

*	Which methods are you using? Why?

*	How is your work going to contribute to the field/or to whom (e.g., industry)?

*	What does the rest of the report look like? In one short paragraph, list the 
topics of the following sections.
-->

## 1.1 Topic of choice and literature review

The European Parliament (EP) is composed of 705 members (MEPs), all elected officials. While these officials are elected to represent the European people as a whole, they are often also a member of a national party of one of the European Union (EU) member states. The officials of national parties then form European groups in the EP based on the ideology of the national parties.

An interesting political clash to investigate is between ideology and national interest. European groups are formed based on a common ideology, yet all its internal members also have to take national interest into account. It is probable that for certain bills that are closely connected to the ideology of a group, unity inside that European group is very high. At the same time, bills that are further apart from the ideology and where national interest play a larger role may lead to a different and more varied voting behavior for the group. For instance, we expect a high level of unity inside the Greens group when they are voting on a bill related to industrial climate effects. At the same time, such a group might be more influenced by national interests when it votes on a bill related to sociological climate effects relating to inequality of CO2 emissions.

Most of the climate debate is centered around reducing CO2 emissions and transitioning from fossil fuels to renewable energy sources, yet little attention has been given to how climate change is affecting the world in a sociological way. Take for example the effect of climate change on indigenous peoples, they produce hardly any greenhouse gases, yet they are impacted heavily because they do not have the resources to protect against flooding and they are highly dependent on land for farming and living. For this research paper we would like to investigate the cohesion of agreement within European countries on the sociological bill related to climate effects on vulnerable populations in developing countries. There we might be able to distinguish different voting behaviour for different countries that may also relate to the development of a certain country (take for example The Netherlands vs Romania). Since the bill on sociological climate effects is a relatively new point of discussion with respect to the heavily discussed industrial climate bill, we will first evaluate whether the voting behaviour with regard to these two bill is consistently using the following research question:

_RQ1: “What is the correlation between the network from the sociological climate bill and the network from the industrial climate bill?”_

Research on parliaments has shown that political parties are decisive for influencing MEPs voting behaviour [@Muller2000]. The party groups unite individual MEPs, organize the agenda and determine the procedure of the parliament [@Kopecky1996]. This research suggets that the European groups do heavily influence the voting behaviour of the individual MEPs. Assuming that the voting behaviour of the MEPs is influenced by their respective groups, and the fact that the composition of the European groups is the same for for both votes, it is expected that the MEPs vote similarly over both votes. Using this logic, the following hypothesis is formulated:

_H1: “We expect a high level of correlation”._

Although the purpose of the European groups is to have unity in the voting behavior of its members, it can be the case that the interests from certain national parties clash with those from the European group. For instance, the European Christen Democrats group (EPP) has been in a big dispute with Hungary's Fidesz party, eventually even leading to the national party leaving the group after being threatened to get kicked out [@de_la_baume_orbans_2021].

Given potential clashes between national and European interests, we are interested to investigate the unity and dynamics inside European countries for the sociological climate bill. As such, we have formulated the following research question:

_RQ2: “What is the cohesion of agreement, based on the sociological climate bill, for MEPs with the same nationality?”_

As stated before, the European groups are expected to strongly influence the voting behaviour of the individual members of the European Parliament. However, other research indicates that MEPs keep a national orientation, what can be linked to the distributive theory, which states that re-election is the main goal of legislators [@Scully2005, @Weingast_and_Marschall1988]. This suggests that MEPs not only vote according to the European group interest, but also according to the national party interest. Following this reasoning, the following hypothesis is formulated:

_H2: “We expect a high level of cohesion.”_

Here we define cohesion in line with the definition provided by [@cherepnalkoski_karpf_mozetic_grcar_2016] who view cohesion as the propensity to vote in the same manner within the same group, here the same European parliamentary group.

Our work is going to contribute to the field by providing additional insight into the voting behaviors of given MEPs. Our data being recent (2021) can suggest whether voting patterns have remained similar over time in comparison to other studies such as [@Eveland2013; @Schneider2007; @Nicoll_Victor2017]. 

The study will give possible factors that influence the final voting outcome for a given bill. The tools deployed to tackle this problem are described in further sections. They will allow to compare objectively using statistical tools, for instance ERGM. The creation of these models allow a better understanding of which factors influence the formation and dissociation of coalitions and political party cohesions.

### 1.1.1 Roll-call votes

The analysis conducted in this paper is carried out over a set of 61 roll-call votes from two motions for European Parliament resolutions concerning different political areas of interest (45 from a sociological-climate related motion and 16 from an industrial-climate related motion). Roll-call votes are votes conducted in the European parliament where the vote (or absence of vote in some cases) of an MEP is recorded along with their name. Roll-call votes are only held under certain conditions, for example, when requested by a significant number of MEPs or if it is impossible to determine a majority from a show of hands [@cherepnalkoski_karpf_mozetic_grcar_2016]. These votes are documented in the minutes of that day’s parliament session and are accessible on the European parliament site.

The report proceeds as follows. Firstly the methodology is explained. Some general comments are made on obtention of the data, along with exploratory results under the form of plots. Secondly, an explanation of the exact manner of how the network and its modelling is constructed. Thirdly, an interpretation of the modelling results of the networks, how it relates and partially answers the research questions given previously.

\newpage

# 2. Methodology

## 2.1 Dataset 
<!-- 
Dataset Description (about 500 words) 1 POINT (+ BONUS)

*	Which data set are you going to use? Three options:

  *	Use readily/easily available data (0 bonus points)

  *	Combine two or more existing datasets (max 0.5 bonus points)

  *	Scrape or collect your own data (max. 1 bonus point)

*	Clearly explain where the data is coming from:

  *	Who collected the data?

  *	What is the source?

  *	When was the data produced?

  *	How was the data collected?

*	Provide descriptive measures of your data (tables, plots, etc.)


*	Why is this data useful to study your topic and answer your research questions?

*	What is the potential bias in the data? How does this affect your results?
-->

### 2.1.1 Source of data and collection

As the dataset for this research two votes of the European Parliament, both on May 18th 2021, are scraped from the VoteWatch.eu website. The code used to scrape the data can be found in the appendix<!--ADD REFERENCE TO APPENDIX-->. The first vote is named "The impacts of climate change on vulnerable populations in developing countries", and has 45 roll-calls. The second vote is named "Research Fund for Coal and Steel", and has 16 roll-calls. The full official document of the votes can be found in the appendix<!--ADD REFERENCE TO APPENDIX-->. VoteWatch is a non-profit organization with the goal of providing insight into the European Parliament and their decision making for European citizens. VoteWatch describes their methodology on their website to a great extend [@noauthor_votewatchmethodology_nodate]. The foundation, however, lays in them automatically scraping the voting data from the European Parliaments own website.

The two analysed votes are purposefully chosen in order to analyze the potential difference in the network effects within the European Parliament for different areas of politics. Stereo typically, political views on climate change on the one hand, and coal & steel industry on the other hand are often adverse, which make these votes interesting to analyze. Furthermore, the votes took place on the same date, which eliminates influence of various possible external parameters. Some examples of such parameters are the date of the vote, the composition of the parliament, or short-lived political ideologies.

### 2.1.2 Usefulness of data for research questions and potential biases

The collected data concerns the names of MEPs, their nationality, European-level political party and vote for each relevant motion for resolution. This data provides enough information to be able to answer the research questions discussed above, as the effect of political party and nationality on agreement between MEPs can be modeled. The collection of data from two motions in different fields also provides the opportunity to be able to compare the network of agreement between the two areas and comment on similarities and differences. The creation of two networks from these two datasets is discussed in the next section of this paper.
A limitation of the data collected is the lack of information about the personal network dynamics at play in the European parliament. Agreement between individuals is likely also influenced by who they are friends with and collaborate with most often. There are likely also more powerful members of the party such as national and European-party level leaders who may therefore invoke a higher level of agreement from others. With the data collected these dynamics are either impossible to model or can only be done in a limited manner.
For this research only two motions were chosen rather than examining all relevant motions in the current period. This has been carried out in previous research, see @cherepnalkoski_karpf_mozetic_grcar_2016 but was deemed to be too time consuming for this initial research. The research carried out in this paper is therefore considered to be a point-in-time comparison which could trigger future investigation if this brief analysis indicates interesting results.
An issue with the collection method of the roll-call data is that it was collected via a third-party website VoteWatch rather than the European parliament website. This decision was taken due to the significant difference in ease in navigating and accessing the data on the two sites. The risk of this choice is considered to be small as the aim of VoteWatch is transparency so the data is likely to be accurate. However, it is not impossible that inaccuracies and differences could have been caused when reproducing the vote results between the two websites. Given more time to conduct this research, a next step would be to build a method for finding the relevant votes in the European parliament minutes and scraping the data directly.

## 2.2 Research Rationale
<!--
Data Analysis (Research Rationale) (about 500 words) – 1 POINTS

*	Why are these two methods suitable for your data?

*	Why are these two methods suitable for your research questions?

*	Are there other methods to address these questions? If yes, why are the 
methods you chose better for this case?
-->

The first research question looks into the correlation between the network from the sociological climate bill and the network from the industrial climate bill. We propose to use a QAP correlation test to find an answer for this question. QAP is similar to CUG, in that it uses statistical simulation to generate a distribution of hypothetical networks. However, with QAP we do not generate a series of random graphs (with some properties such as a given size and density), but we now control for all purely structural properties of the two graphs being compared themselves. This is done by making permutations of the networks that are to be compared, similar to the practice of bootstrapping.

A QAP correlation test is the most suitable option. A QAP test is suitable for situations where two or more networks have to be compared with each other. For the second research question, two networks, based on votes from two different bills, have to be compared. A CUG model would not work here, since it is only about investigating the network measures of one network. Similarly, an LNAM model focuses on the social influence in a network and is not applicable. It might be possible to make two ERGM models for the bills, where explanatory variables are included that represent groups that vote alike, but this would be needlessly complex and inferior to the QAP test. Lastly, a MRQAP model is not necessary since only two networks have to be compared. 

The second research question investigates the cohesion of agreement, based on the voting behaviour for the sociological climate bill, for MEPs with the same nationality. In the network used for this research question, two MEPs are connected if they agree on all amendments within the bill. Since we want to explain the reason why a tie is formed in the network or specifically between two MEPs, we propose to use an exponential random graph family model or ERGM for short. An ERGM is a class of network models to perform causal inference and deduce the cause of an observed relation phenomenon that we observe and conceptualize as a network. The model will include endogenous and exogenous terms since the nationality is an attribute of the vertices and therefore a term like nodefactor needs to be used. Nodefactor is a Markovian term that measures the extent to which being in a certain category influences edge formation. We specifically need to use the regular variant as opposed to the directed in or directed out variant since the climate bill network is undirected. The complexity and flexibility of ERGM makes this technique very suitable for verifying this research question. The other techniques are not suitable for this type of analysis since CUG and QAP are used for checking whether a network statistic is statistically significant and comparing two networks respectively. More simple methods like logistic regression are also not an option, since they do not allow for endogenous terms. As such, ERGM is the most suitable method for this specific research question and data.

<!--
Bram 15/nov: Maybe add something about previous research using ERGM (see list below)
There are numerous studies that used this method such as:

* Gondal, The local and global structure of knowledge production in an emergent research field, SOCNET 2011 

* Lomi and Palotti, Relational collaboration among spatial multipoint competitors , SOCNET 2011 


* Wimmer & Lewis, Beyond and Below Racial Homophily, AJS 2010 

* Lusher, Masculinity, educational achievement and social status, GENDER & EDUCATION 2011 

* Rank et al. (2010). Structural logic of intra-organizational networks, ORG SCI, 2010.

Reply Laurens 3/dec: Claudia stated during one of the feedback sessions that referencing literature is not necessary for this section. So I’m not including it and consider this comment resolved, but others are free to add a paper if they think it really improves argumentation about why these methods (QAP & ERGM) are best for the data and RQs.
-->

\newpage

# 3. Results
<!--
Results Description (about 2000 words)
-->

## 3.1 Creation of the networks

A decision was needed to be made regarding the nature of the edges in the network. One technique could be that agreement between MEPs would be summed creating a weighted edge equaling the number of times the two MEPs agreed in the bill. This network can be used for our first research question using a QAP-test to look at correlation. However, for the second research question, a traditional ERGM model can only handle binary edges. More recent ERGM techniques can cope with weighted edges, however due to the scale of the network in question (705 nodes) this was not considered feasible during the time-period of this research and could be considered as a future area of research based on the results of this paper.

Therefore, in order to create a binary network of agreement between MEPs a decision was required to determine what conditions would create an edge between a pair of MEPs. Previous research has created networks from each individual roll-call vote where an edge equals agreement in that particular vote [@cherepnalkoski_karpf_mozetic_grcar_2016]. In this research it was also decided that each edge should represent agreement between two MEPs. While it is clear that two MEPs are in agreement if they both vote for or both against a motion, this is less clear in the case of abstaining, being absent or just not voting. This could be due to disagreement with the motion, perhaps an unwillingness to go against your party but could also be due to a personal issue, logistical problem or lack of information. It is therefore not possible to say if these MEPs have the same opinion about the vote. An agreement is therefore only considered valid in this research if they both voted for or against. However, being able to make conclusions from this method requires an ERGM model to be created for each roll-call vote and then the results combined using a meta-analysis method. Therefore, given the time restrictions of this project, a decision was made to create an edge between individuals based on agreement in a certain number of votes or more following the approach adopted in previous papers, see @cranmer_desmarais_2011, and thus implenting a so called threshold. More about this threshold is explained later in the results. The networks created in this research, using the above mentioned methods, are all unimodal networks. 

## 3.2 Descriptive measures

In order to get a better overview of the dataset, the five-number summary is computed for both the sociological climate motion and the industrial climate motion. The following two tables show these statistics for the two weighted networks where there is an edge between MEPs if they agree in at least one sub-vote. As this is an undirected graph we just show the number of nodes and edges rather than the dyad-cencus since this would not provide any additional information.The centrality chart for these networks was also examined but was difficult to interpret given number of nodes included. Additionally, the centrality chart pointed towards the low centrality of the graphs which is easy to confirm with the statistics below. Due to the high transivity and density of the graph, there are not many specific nodes that are more/less central in the graphs.

The summary statistics of the graph already point to a high level of similarity in structure. They both have very high density and transitivity. They also have the same path length and diameter, likely due to the many connections between nodes in both graphs.

```{r echo=FALSE}
tab_statistic(u_net_soc_clim, "Statistics for weighted sociological climate network")
tab_statistic(u_net_ind_clim, "Statistics for weighted industrial climate network")
```

As previously discussed, to begin the ERGM testing it was required to transform the networks from weighted networks to binary networks. This required the choice of thresholds. Therefore to aid this process, the five-number summary was plotted for the networks using all possible absolute number thresholds (see plots below).Histograms of the spread of agreement are also plotted below to provide context for the other statistics.
There will therefore be an edge between two parliament members if they have a minimum agreement equal or above the threshold. The lowest threshold for an edge in these graphs is therefore one, meaning that the MEPs agreed on one and only one subvote in the bill. For low level of agreement this could therefore mean that MEPs only agreed very few times. Therefore not all edges are a result of causal relationships or represent a significant amount of agreement. The aim was therefore to set thresholds so as to create a network of the most important, non-random relationships. Frequency plots (displayed in the appendix) are therefore examined to try and determine the most appropriate thresholds, which will be explored in further detail in the next sections.
For clarity the thresholds considered here are absolute numbers of votes on which the MEPs agree on. Since every MEP has the opportunity to be both present and vote on each motion for each resolution then this is considered to be a clear and fair method for testing levels of agreement.


### 3.2.1 Sociological Climate Motion

The graphs for the social climate motion initially show a dense network with a short average path length. This can be explained by the fact that with the full dataset, almost all members of the EP are connected to each other through at least one voting agreement. This is logical, given that they would just need to agree on one vote. However, this is not the most relevant information for this research. 

Instead, two key points of change are noted in the graphs: agreement between 12-18 and agreement above 38. For expample,it is observed from the transitivity measure figure that at an agreement threshold of 15, there is a drop in transitivity. This signals that there is a reduction in clusters when a threshold of 15 is set. Similarly, the network density plot shows a vast decline around the threshold of 15, indicating a large reduction of edges. This behaviour can be seen when plotting the graphs (displayed in the appendix - MEPs have been plotted with their European party clearer to make clustering behaviour more obvious) as clearer subcommunities begin to appear. The median amount of agreement between MEPs in this dataset of 17 also underlines this range being a significant point in the network. 

Additionally, a small drop in transitivity and density can be observed at an agreement threshold above 38 as well. This is interesting to observe, since at an agreement threshold of 38 and above, the MEPs agree on almost all votes. The density plot also shows, that there are fewer connections left, indicating that a smaller proportion of MEPs agree with each other at this significant level.This is clear when comparing the relevant plot where initially at a threshold of 38 there is still one large community. When the threshold is raised to 44 then this community has fractured into much smaller sub-groups


### 3.2.2 Industrial Climate Motion

As for the industrial climate motion, a dense network with a short average path length can be observed as well for the full network. Again, all members are connected to each other through some voting agreement. As such, it becomes even more important to eliminate the random voting agreements in order to visualise the most important relationships between members of the European Parliament. 

The transitivity clearly shows two key drops between 3-5 and 11-14. This signals that there is a reduction in clusters. Similarly, the density plot also signals a drop in density at a threshold of 4 and 13, indicating that many connections disappear at these stages. This matches the results from the histogram as there are many pairs of MEPs with agreement around these levels. The changes to the network are modelled in visualisations displayed in the appendix, particularly in the comparison of the threshold of 3 and 5 where there has been a clear fracturing into subcommunities.

In contrast to the social climate motion the median in agreement in this data is 13 showing a much higher average amount of agreement in this network. This is likely due to the high number of MEPs (around 5000) pairs that are in total agreement across all votes.


<!-- The piece below should be under Threshold determination? Or can we leave it out??-->

For the social climate motion, it can be assumed that by setting the threshold slightly past 15 will eliminate random edges between members of the EP. As for the threshold of 39, it would be interesting to observe given that the remaining connections capture extreme agreement, relevant to our research. As for the industrial climate motion, it can be concluded that a threshold of 4 definitely removes the first set of random voting agreements. Additionally, a threshold of 13 also removes a large set of edges between members of the European Parliament, but it is yet to be evaluated whether these are random agreements or not. Instead, the threshold of 13 actually captures connections with extreme agreement. Therefore it would be interesting to use the number of voting agreements of 4 and 13 as thresholds for the remaining of our research.


## 3.3 Threshold determination

Following the descriptive analysis, an appropriate threshold had to be determined. If the threshold would be too low then it would be more likely to cause degenerate graphs as most MEPs are likely to agree with each other on at least a few occasions leading to very dense graphs. On the other hand, if a too high threshold is selected then interesting network dynamics could be omitted by only including edges between MEPs who almost completely agree with each other. A balance therefore had to be found by examining the networks for a selection of thresholds, comparing density, transitivity and other important statistics.

As previously discussed in the descriptive analysis section, both datasets had two specific ranges where the structure of the network significantly changed. The decision was therefore made to set the threshold for the networks used in this paper just above these ranges. This was chosen as it was considered likely that the more frequent levels of agreement between MEPs were likely by chance- particularly at lower levels.

### QAP Thresholds
In order to be able to compare the analysis of both networks it was considered desirable to use the same thresholds on both networks. Therefore percentage thresholds were identified to be used: above 35% agreement and above 95% agreement. These both relate to the two ranges identified in the descriptive models above and their respective medians.See the histogram below (social climate frequency in peach and industrial climate frequency in lilac, pink where they overlap) for an illustration of the dynamics focused on by setting these thresholds.

### ERGM Threshold
For QAP it was decided to evaluate the 35% and 95% thresholds for full coverage and also to see if there is a different association at different level of agreement. For the ERGM however, it was decided to use a 100% threshold for agreement in order to thoroughly investigate agreement within European countries. This way, extreme agreement can be analysed, giving a good and clear indication of the cohesion within countries. Using a 100% agreement threshold to form edges between MEPs, the network created is an undirected unweighted network containing 705 vertices (MEP’s) and 6811 edges. As explained in the previous sections an edge is formed between two MEP’s if they vote the same on every roll call in the bill.

### Testing created networks
With these thresholds and data in mind, the networks models were created, visualised and explored.  Summary statistics for these networks were also computed.  The most prominent differences shown here are in graph density and diameter of the graphs. The centrality charts for these networks were also computed but failed to show significant results due to the scale of the network. The only point of note is the range of degree which can be seen already in the degree distribution. All of these plots, tables and visualizations can be found in the appendix.

All selected networks were all separately tested to ensure the best chance of finding a converging ERGM model. It is also possible that different dynamics might be in play in the model for occasional agreement (above 35%) in comparison to almost total agreement (above 95%) which can be tested with these models. 





```{r echo=FALSE}
p1 <- hist(edges_soc_clim$agreement_percent,
           xlab = "Agreement Frequency",
           ylab = "Frequency",
           main = "Climate Agreement Percentage Distribution")
p2 <- hist(edges_ind_clim$agreement_percent,
           xlab = "Agreement Frequency",
           ylab = "Frequency",
           main = "Industy Agreement Percentage Distribution")

# First histogram
plot(p1,
     col = rgb(1, 0, 0, 1/4),
     xlim = c(0, 1),
     xlab = "Agreement Frequency",
     ylab = "Frequency",
     main = "Edges Social & Industrial bills w/ Selected Thresholds")

# Second histogram
plot(p2 , col = rgb(0, 0, 1, 1/4), xlim = c(0, 1), add = TRUE)

# Threshold lines
abline(v = 0.35, col = "blue", lwd = 3)
abline(v = 0.95, col = "blue", lwd = 3)
abline(v = 1.0, col = "blue", lwd = 3)

# Legend
legend(x = -0.0325,
       y = 40000,
       legend = c("Social", "Industrial"),
       col = c("red", "blue"),
       lty = 1,
       lwd = 5)
```


## 3.4 QAP test

In this section the correlation between the social climate vote network and the industrial climate vote network was analysed with QAP-tests to give an initial indication of the answer to the first research question. A QAP test can be used here as both networks cover the same group of MEPs, therefore the linear subspace method can be used. Calculating the correlation therefore involves comparing the existence of an edge (and its weight if included) between two MEPs in the first network with the existence of an edge between the same two MEPs in the second network.

A QAP test involves permuting both networks multiple times and each time calculating the correlation of the two networks to create a distribution of correlations. This is then compared to the correlations of the original networks to see if the statistic that is calculated on the original graphs is extreme for a graph controlled by this size and structure. This likelihood of observing this statistic is reflected in the p-value returned. This therefore uses the original graph and creates a distribution based for comparison of what the association would be under the null hypothesis of there being no association. The product-moment correlation statistic is used here as the most common statistic for correlation in networks [@MEGHANATHAN2021339].

QAP tests were carried out on the full network, the 35% threshold network, the 95% threshold network and with the weighted networks for full coverage and also to see if there is a different association at different level of agreement. For example, it is possible that there could be less correlation with lower thresholds due to random noise that could come from a chance agreement between two MEPs. In contrast, in the comparison of the two 95% networks we expect an extremely high level of correlation as the agreement is not then likely by chance. This is particularly true in this case as it can be expected that if an MEP has a strong opinion on what should be done regarding the human impact of climate change that they would also have strong opinions about what could be done in industry that might improve/ worsen the climate issue. 

The resulting graphs from the QAP tests can be viewed below. It can be immediately seen that the correlation between both networks in all four tests is very significant. The correlation between the full networks (an edge between MEPs if they agree at least once) has a high correlation of 0.641 (p-value = 0.000). However, upon examination this is likely due to the very high number of edges in the initial network- if all MEPs agree with the other MEPs on at least one vote then the whole network will be connected. This is reflected in the high densities of these graphs (0.964 and 0.977). This would explain the very high level of association as the probability is therefore very high that there will be a matching edge in the other network. 

The result from the thresholded networks is perhaps then more interesting. There is a lower but still significant correlation of voting agreement in the 35% networks of 0.346 (p-value= 0.000) and a slightly higher correlation with the 95% network of 0.397 (p-value= 0.000). The decrease in correlation compared to the initial network will be due to us now comparing far sparser networks, there is less chance that two MEPs agree 35% or 95% of the time so therefore a lower probability that a pair of MEPs will have an edge between them in both networks. However, the higher correlation in the 95% graph compared to the 35% graph is likely due to the high threshold set. While the 35% thresholded networks could still include pairs of MEPs who agreed with each other by chance 35% of the time this is extremely unlikely with the 95% network. These networks therefore focus on very specific voting agreement. An example of this voting agreement can be seen by examining the edges present in the 95% graphs as in both networks nearly all members of the Progressive Alliance of Socialists and Democrats party completely agree with each other. This is an example of the behaviour that can cause the association in the networks noted here.

Finally, the most interesting result is perhaps the QAP results from the weighted networks. As opposed to the tests carried out on the binary networks this test also includes the information about the amount of agreement (measured as a percentage) between the two MEPs. Unlike the other QAP graphs, here there is an overlap between the result observed in the networks and the permuted graphs in the QAP test. However, the correlation between the two graphs is still highly significant with a correlation of 0.03 (p-value:0.004) 

```{r echo=FALSE}
par(mfrow = c(2, 2), cex = 0.6)
mep_cor <- sna::qaptest(list(w_net_soc_clim_nw, w_net_ind_clim_nw),
                        FUN = sna::gcor,
                        g1 = 1,
                        g2 = 2,
                        mode = "graph",
                        reps = 1000)
sum_mep_cor <- summary(mep_cor)
sna::plot.qaptest(mep_cor, xlim = c(min(sum_mep_cor[[2]]) - 0.005, sum_mep_cor[[1]]))

mep_cor_35 <- sna::qaptest(list(uw_net_soc_clim_35_nw, uw_net_ind_clim_35_nw), 
                           FUN = sna::gcor,
                           g1 = 1,
                           g2 = 2,
                           mode = "graph",
                           reps = 1000)
sum_mep_cor_35 <- summary(mep_cor_35)
sna::plot.qaptest(mep_cor_35, xlim = c(min(sum_mep_cor_35[[2]]) - 0.005, sum_mep_cor_35[[1]]))

mep_cor_95 <- sna::qaptest(list(uw_net_soc_clim_95_nw, uw_net_ind_clim_95_nw), 
                           FUN = sna::gcor,
                           g1 = 1,
                           g2 = 2,
                           mode = "graph",
                           reps = 1000)
sum_mep_cor_95 <- summary(mep_cor_35)
sna::plot.qaptest(mep_cor_95, xlim = c(min(sum_mep_cor_95[[2]]) - 0.005, sum_mep_cor_95[[1]]))

s_m <- network::as.sociomatrix(w_net_soc_clim_nw, matrix.type="adjacency", attrname="weight")
i_m <- network::as.sociomatrix(w_net_ind_clim_nw, matrix.type="adjacency", attrname="weight")

mep_cor_w <- sna::qaptest(list(s_m, i_m), 
                          FUN = sna::gcor,
                          g1 = 1,
                          g2 = 2,
                          mode = "graph",
                          reps = 1000)
sum_mep_cor_w <- summary(mep_cor_w)
sna::plot.qaptest(mep_cor_w, xlim = c(min(sum_mep_cor_w[[2]]) - 0.005, sum_mep_cor_w[[1]]))
par(mfrow = c(1, 1))
```

From the results it can therefore be concluded that there is an association between how pairs of MEPs agreed in the sociological climate bill and the industrial climate bill for both weighted agreement, with thresholds for incidental agreement and almost total agreement. This therefore provides evidence in line with the first hypothesis of this paper, which states that there is high correlation between the sociologcial climate bill and the industrial climate bill.



## 3.5 ERGM

<!--
ERGM Description (about 1000) – 2.5 POINTS

* Present your results appropriately (plots, tables…) and discuss your findings 
in plain English

* Discuss the meaning of your findings in relation to your hypothesis. (half of 
the points evaluated in this other part)
-->

```{r echo=FALSE}
# Load models from cache
m0 <- readRDS("../../models/m0.rds")
m0_fit <- readRDS("../../models/m0_fit.rds")
m2_1 <- readRDS("../../models/m2_1.rds")
m2_1_fit <- readRDS("../../models/m2_1_fit.rds")
m2_2 <- readRDS("../../models/m2_2.rds")
m2_2_fit <- readRDS("../../models/m2_2_fit.rds")
m4 <- readRDS("../../models/m4.rds")
m4_fit <- readRDS("../../models/m4_fit.rds")
```

In this section the cohesion of agreement, based on the sociological climate bill, for MEPs with the same nationality was investigated. Networks are created that test the hypothesis that a high level of cohesion is expected between MEPs with the same nationality in the European parliament. ERGM is used to test this hypothesis since edge formation is being investigated in one network. The influence of the country on edge formation in the network is measured using Markovian terms, in combination with structural terms to capture the essence of the network. Markovian effects are effects that happen in a small neighbourhood of a network. In the case of this hypothesis the effect of vertices characterized by a specific category (country) belonging to a certain attribute form ties with other nodes characterized by the same category (country) needs to be investigated. To investigate this relation the nodematch exogenous term can be used.

ERGM models are part of the exponential random graph model family. These models can be used to decide the cause of an observed relational phenom in a network. ERGMs make use of Monte Carlo Maximum Likelihood estimation. In other words, the ERGMs generate a series of matrices representing the network, differing one edge at the time. Then the Metropolis Hastings or Gibbs sampler algorithm is used to decide which entries change state. Only the state that increases the likelihood of observing the given network is retained, after which the simulation progresses. ERGMs are built sequentially meaning that after a term is added to the model formula, the model will be carefully evaluated using the Goodness-of-Fit Metrics and the MCMC Diagnostics before proceeding.

Structural terms are a requirement for ERGM’s to properly fit the network. There are 176 different structural terms, each term captures a different type of relation in the network or builds upon another structural term. To properly pick structural terms the network in question needs to be analyzed in detail. The first structural term analyzed is degree which immediately shows the interesting result that there are 567 vertices with degree 0 (isolates) (see appendix). It can also be seen that there are 117 vertices with degree 116 indicating a very dense community within the network. Further inspection shows that the 117 vertices with degree 116 are all from the S&D, indicating that this particular party has a very strict voting policy. The second structural term analyzed is kstar, it might be that there is one party leader in the S&D community that instructs all the other party members to vote a certain way. By investigating the results it can be observed that there are stars present in the network (see appendix).

A total of four models were fitted to answer this research question (see appendix for models). The first model (m0) only contains an intercept: edges. This model managed to converge in about 5 seconds but performance is not great as indicated by the Goodness-of-Fit Metrics. This was expected because the model does not contain any of the structural effects and will therefore be used as a baseline model to compare the other models against. The second model (m1) contains the intercept and an structural term to account for the large amount of isolates in the network: edges + isolates. This model crashed, throwing a degeneracy error. Model 2.1 (m2_1) and model 2.2 (m2_2) build upon this model including gwdegree or altkstars as structural terms. The curved variants of these two terms are used since the network that is being investigated is too large to use regular terms. Model 2.1 converged in about 2 minutes showing good Goodness-of-Fit Metrics and MCMC Diagnostics (see appendix). Model 2.2 failed to converge within the set iteration limit (60) and was therefore discarded. Model 3 (m3) tests an alternative hypothesis if party membership has a positive on agreement between MEP’s in the European Parliament, by including nodematch(“party”) alongside the terms used in model 2.1. However this model failed to converge within the time limit of 45 minutes set by the group and therefore these results cannot be interpreted. The final model 4 (m4) test the second research question: What is the cohesion of agreement, based on the sociological climate bill, for MEPs with the same nationality. The model converged about 2 minutes showing promising results in the output as well as the Goodness-of-Fit Metrics and MCMC Diagnostics.

```{r echo=FALSE, results="asis"}
texreg::knitreg(list(m0, m2_1, m2_2, m4),
                custom.model.names = c("Model 0 (m0)", "Model 2.1 (m2_1)", "Model 2.2 (m2_2)", "Model 4 (m4)"),
                custom.gof.rows = list(GOF = c("FAIL", "PASS", "PASS", "PASS"),
                                       MCMC = c("-", "PASS", "FAIL", "PASS")))
```

By analysing the Goodness-of-Fit Metrics it can be observed that the model has a decent fit. The line mostly goes through all the blue points and stays within the boundaries. The results for the model statistics show a little weird behaviour but this can be explained by reanalysing the results for degree (see appendix). There are no vertices between degree5 and degree116, which is also highlighted by the flat line in the plot between these two values. Before degree5 and after degree116 the line moves between the error boundaries showing a decent result. The MCMC Diagnostics for model 4 are looking fine, the chains are mixing well for all model terms and the distributions are nicely centered around the zero. Proceeding with analysing the actual results from the model it can be observed that nodematch(“country”) is statistically significant and by interpreting the coefficient the conclusion can be drawn that there is an 84% probability that two MEP’s agree on a sociological climate bill if they are from the same country. This is in line with the initial hypothesis of this research, which states that there is a high level of cohesion between the sociological climate bill and the industrial climate bill.

```{r echo=FALSE}
knitr::kable(SNA4DS::Ef_int(m4, type = "prob"), caption = "Model 4 (m4)")

par(mfrow = c(2, 2))
plot(m4_fit)
par(mfrow = c(1, 1))

invisible(capture.output(ergm::mcmc.diagnostics(m4, which = "plots")))
```

\newpage

# 4. Conclusion
<!--
Conclusion Description (about 350 words) – 0.7 POINTS

What were your topic and research questions again? (1 sentence)

What did you learn from the two analysis you run? *** most important point to 
address 0.5 POINTS here

Who benefits from your findings?

What does remain an open problem?
  - Run ERGM with nodematch("party") to check whether party influences edge
    formation and whether the probability of forming an edge if two MEPs are
    from the same party is statistically signficantly higher than if they are
    from the same country -> ERGM currently does not work with nodematch("party") 

Can you give suggestions for future work in this area?
-->

The topic of the research is to describe the level of cohesion among 705 members of the European parliament according to their political and national affiliation using an undirected network collected from two environmental-related bills. Given the QAP results, it can be seen that the voting behavior is significantly similar given the correlation result. Consequently, the ERGM which was only ran on the sociological-climate bill, could be assumed to be generalizable enough for both networks. It appears from the latter analysis that MEPs within a country vote almost identically to one another at 84%. Given that there are at least three political parties in one country, it can be deducted that MEPs vote in priority in respect to national interests, then according to their political party. The absence of a MEP that votes against all political belonging proves that voting behavior is strongly influenced by connections.  

During the research process several (modeling) limitations were encounteed, as well as interesting areas for future research. Firstly, accessing a supercomputer or paying for servers to run simulations could multiply the number of models that could be ran. Secondly, some questions still remain unanswered. For example, do MEPs abstain or make themselves absent when an internal conflict appear between voting in respect to their duty as a national representant and personal belief. Thirdly, more data. An example would be with personal information about these MEPs. It could be scraped off the internet and processed. This could lead to more interesting analyses and explain whether some characteristics are correlated to a certain voting behavior. This would continue with scraping more voting results on a plethora of political concerns. Fourthly, more advanced statistical network analysis tools could be deployed. Lastly, isolates, absentees, and abstainers are interesting MEPs not investigated in this research. The reason behind those positions could be revealed in future research. This investigation would need a manual peeling of internet in search of subtle details to find out their true agenda which may take months. Internal political gossips could be taken into account yet their retrieval can be time-consuming while necessitating a political degree. Additionally to the research, lots of voting session will have to be taken into account exploding the dimensionality. 

\newpage

# References

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id="refs" custom-style="Bibliography"></div>
\endgroup

\newpage

# Appendix

## A. Dataset creation code

### A.1 Scraping code (VoteWatch)

```python
from urllib.request import Request, urlopen

import pandas as pd

def scrapeWebsite(url):
    #Website to be requested
    req = Request(url, headers={'User-Agent': 'Mozilla/5.0'})
    xhtml = urlopen(req).read()

    string = xhtml.decode('utf-8')
    title = string.split('<div class="div_tabled_info_full">')[1].split('<')[0]
    new_url = string.split('var source_individual_votes = "')[1].split('"')[0]

    req = Request(new_url, headers={'User-Agent': 'Mozilla/5.0'})
    xhtml = urlopen(req).read()

    df = pd.read_json(xhtml, orient='records')

    df['MEP'] = df['all_votes'].astype(str).str.split("mep_name_link': 'https://www.votewatch.eu/en/term9-").str[1].str.split(".html").str[0].str.replace("-", " ").str.title()
    df['group_abbv'] = df['all_votes'].astype(str).str.split("grup': '").str[1].str.split("'").str[0]
    df['country'] = df['all_votes'].astype(str).str.split("euro_tara_nume': '").str[1].str.split("'").str[0]
    df[title] = df['all_votes'].astype(str).str.split("euro_vot_valoare_text': '").str[1].str.split("'").str[0]
    df = df.drop(['all_votes'], axis=1)
    return df
    
# website for motion to be scraped- this was adapted for the motions used
website = 'https://www.votewatch.eu/en/term9-the-impacts-of-climate-change-on-vulnerable-populations-in-developing-countries-motion-for-resolutio.html'

# range updated based on number of votes
for i in range(1,45):
    if i == 1:
        url = website
    else:
        url = website[:-5] + '-' + str(i) + website[-5:]
    
    newdf = scrapeWebsite(url)
    
    if i == 1:
        df = newdf
    else:
        df = df.merge(newdf, on=['MEP', 'group_abbv', 'country'])

# Fixing data issue
df = df.replace('Didn&#39;t vote', "Didn't vote") 
df.head()

# Saving results to csv
df.to_csv(r'mepdata.csv', index = False)

# Checking number of rows
df_len = len(df)
if df_len == 705:
  print("The dataset has {} rows which equals the expected 705 MEPs".format(df_len))
else:
  print("The dataset has {} rows which is not equal to the  expected 705 MEPs".format(df_len))

# Checking for missing data
if df.isnull().values.any() | df.eq('').values.any():
  print('The dataset has missing values')
else:
  print('The dataset has no missing values')

# Checking no issues with duplicates
if df["MEP"].is_unique:
  print('The MEP column has no duplicates')
else:
  print('There are duplicate values in the MEP column')
```

### A.2 Create edges

```python
import pandas as pd
import os
from pathlib import Path

df = pd.read_csv(os.path.join(Path(os.getcwd()).parents[1],'data','MEP_social.csv')) 

df.head()

# Creating index column
df.reset_index(inplace=True)
df = df.rename(columns = {'index':'index_no'})

# Function to compare two MEPs to check their agreement
def compare_row(row1, row2):
    # Initial agreement is 0
    count = 0
    for elem, elem2 in zip(row1[4:], row2[4:]):
        # Only checks for agreement if first MEP has voted for or against (abstain/ not present not considered as something that can be agreed on)
        if (elem == 'For') | (elem == 'Against'):
            # If the two MEPs agree on this vote then increment count by 1
            if elem == elem2:
                count = count + 1
    # Return final count of agreement for the two MEPs
    return count

# Creating new dataframe to hold weighted edges
edges = pd.DataFrame(columns=['MEP_1', 'MEP_2', 'Agreement'])

# Iterate through each MEP row
for index, row in df.iterrows():
    # Printing MEP index to track progress
    print(row.index_no)
    # Iterating through MEP rows again
    for index2, row2 in df.iterrows():
        # Only comparing rows if the index of the first MEP is lower than the index of the second MEP
        # To avoid checking MEPs against themselves and not to compare pairs of MEPs twice
        if row.index_no < row2.index_no:
            # Calculating weight of edge
            agreement = compare_row(row, row2)
            # Adding names of MEPs and agreement to dataframe
            edges.loc[len(edges.index)] = [row.MEP, row2.MEP,agreement]

# Printing final output
edges.head()

if len(edges) == 248160:
    print('Correct number of edges')
else:
    print('Something went wrong')

# Saving edges to csv
edges.to_csv(r'edges_for_against_industry.csv', index = False)
```

\newpage

## B. Network analysis

### B.1 Descriptive measures
```{r echo=FALSE}
# Social climate bill
hist(edges_soc_clim$agreement,
     col = "lightblue",
     xlab = "Agreement",
     ylab = "Frequency",
     main = "MEP Agreement Distribution")

par(mfrow = c(2, 2), cex = 0.6)
plot_statistic(igraph::transitivity,
               edges_soc_clim,
               44,
               "Agreement Threshold",
               "Global Transitivity",
               "Transitivity vs. Agreement Threshold")
plot_statistic(igraph::edge_density,
               edges_soc_clim,
               44,
               "Agreement Threshold",
               "Network Density",
               "Network Density vs. Agreement Threshold")
plot_statistic(igraph::mean_distance,
               edges_soc_clim,
               44,
               "Agreement Threshold",
               "Average Path Length",
               "Average Path Length vs. Agreement Threshold")
plot_statistic(igraph::diameter,
               edges_soc_clim,
               44,
               "Agreement Threshold",
               "Diameter",
               "Diameter vs. Agreement Threshold")
mtext("Social Climate Motion", side = 3, line = -19, outer = TRUE)
par(mfrow = c(1, 1))

# Industry climate bill
hist(edges_ind_clim$agreement,
     col = "lightblue",
     xlab = "Agreement",
     ylab = "Frequency",
     main = "MEP Agreement Distribution")

par(mfrow = c(2, 2), cex = 0.6)
plot_statistic(igraph::transitivity,
               edges_ind_clim,
               44,
               "Agreement Threshold",
               "Global Transitivity",
               "Transitivity vs. Agreement Threshold")
plot_statistic(igraph::edge_density,
               edges_ind_clim,
               44,
               "Agreement Threshold",
               "Network Density",
               "Network Density vs. Agreement Threshold")
plot_statistic(igraph::mean_distance,
               edges_ind_clim,
               44,
               "Agreement Threshold",
               "Average Path Length",
               "Average Path Length vs. Agreement Threshold")
plot_statistic(igraph::diameter,
               edges_ind_clim,
               44,
               "Agreement Threshold",
               "Diameter",
               "Diameter vs. Agreement Threshold")
mtext("Industrial Climate Motion", side = 3, line = -19, outer = TRUE)
par(mfrow = c(1, 1))
```


### B.2 Sociological climate bill
```{r echo=FALSE}
par(mfrow = c(1, 2))
plot_network_agreement(edges_soc_clim, 3, igraph::layout_with_lgl)
plot_network_agreement(edges_soc_clim, 5, igraph::layout_with_lgl)
par(mfrow = c(1, 1))

par(mfrow = c(1, 2))
plot_network_agreement(edges_soc_clim, 11, igraph::layout_with_graphopt)
plot_network_agreement(edges_soc_clim, 14, igraph::layout_with_graphopt)
par(mfrow = c(1, 1))
```

### B.3 Industrial climate bill
```{r echo=FALSE}
par(mfrow = c(1, 2))
plot_network_agreement(edges_ind_clim, 3, igraph::layout_with_lgl)
plot_network_agreement(edges_ind_clim, 5, igraph::layout_with_lgl)
par(mfrow = c(1, 1))

par(mfrow = c(1, 2))
plot_network_agreement(edges_ind_clim, 11, igraph::layout_with_graphopt)
plot_network_agreement(edges_ind_clim, 14, igraph::layout_with_graphopt)
par(mfrow = c(1, 1))
```

### B.4 Threshold determination

```{r echo=FALSE}
par(mfrow=c(1, 2))
plot_network_agreement_percent(edges_soc_clim, 0.35, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_soc_clim_35),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 35%")
par(mfrow = c(1, 1))

par(mfrow = c(1, 2))
plot_network_agreement_percent(edges_soc_clim, 0.95, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_soc_clim_95),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 95%")
par(mfrow = c(1, 1))

par(mfrow = c(1, 2))
plot_network_agreement_percent(edges_soc_clim, 1.0, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_soc_clim_100),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 100%")
par(mfrow = c(1, 1))
```

```{r echo=FALSE}
tab_statistic(uw_net_soc_clim_35, "Statistics for social climate network with threshold 35%")
tab_statistic(uw_net_soc_clim_95, "Statistics for social climate network with threshold 95%")
tab_statistic(uw_net_soc_clim_95, "Statistics for social climate network with threshold 100%")
```

```{r echo=FALSE}
par(mfrow=c(1, 2))
plot_network_agreement_percent(edges_ind_clim, 0.35, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_ind_clim_35),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 35%")
par(mfrow = c(1, 1))

par(mfrow = c(1, 2))
plot_network_agreement_percent(edges_ind_clim, 0.95, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_ind_clim_95),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 95%")
par(mfrow = c(1, 1))

par(mfrow = c(1, 2))
plot_network_agreement_percent(edges_ind_clim, 1.0, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_ind_clim_100),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 100%")
par(mfrow = c(1, 1))
```

```{r echo=FALSE}
tab_statistic(uw_net_ind_clim_35, "Statistics for industrial climate network with threshold 35%")
tab_statistic(uw_net_ind_clim_95, "Statistics for industrial climate with threshold 95%")
tab_statistic(uw_net_ind_clim_100, "Statistics for industrial climate with threshold 100%")
```
```{r echo=FALSE}
par(mfrow=c(1, 2))
plot_network_agreement_percent(edges_soc_clim, 0.35, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_soc_clim_35),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 35%")
par(mfrow = c(1, 1))

par(mfrow = c(1, 2))
plot_network_agreement_percent(edges_soc_clim, 0.95, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_soc_clim_95),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 95%")
par(mfrow = c(1, 1))

par(mfrow = c(1, 2))
plot_network_agreement_percent(edges_soc_clim, 1.0, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_soc_clim_100),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 100%")
par(mfrow = c(1, 1))
```

```{r echo=FALSE}
tab_statistic(uw_net_soc_clim_35, "Statistics for social climate network with threshold 35%")
tab_statistic(uw_net_soc_clim_95, "Statistics for social climate network with threshold 95%")
tab_statistic(uw_net_soc_clim_95, "Statistics for social climate network with threshold 100%")
```

```{r echo=FALSE}
par(mfrow=c(1, 2))
plot_network_agreement_percent(edges_ind_clim, 0.35, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_ind_clim_35),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 35%")
par(mfrow = c(1, 1))

par(mfrow = c(1, 2))
plot_network_agreement_percent(edges_ind_clim, 0.95, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_ind_clim_95),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 95%")
par(mfrow = c(1, 1))

par(mfrow = c(1, 2))
plot_network_agreement_percent(edges_ind_clim, 1.0, igraph::layout_with_graphopt)
hist(igraph::degree(uw_net_ind_clim_100),
     ylim = c(0, 600),
     xlab = "Degree",
     ylab = "Frequency",
     main = "Degree Distribution, Threshold: 100%")
par(mfrow = c(1, 1))
```

```{r echo=FALSE}
tab_statistic(uw_net_ind_clim_35, "Statistics for industrial climate network with threshold 35%")
tab_statistic(uw_net_ind_clim_95, "Statistics for industrial climate with threshold 95%")
tab_statistic(uw_net_ind_clim_100, "Statistics for industrial climate with threshold 100%")
```


## C. Detailed QAP results

<!-- TODO: put these results in a table -->
```{r echo=FALSE}
print("QAP results for full networks")
sum_mep_cor

print("QAP results for 35% thresholded networks")
sum_mep_cor_35

print("QAP results for 95% thresholded networks")
sum_mep_cor_95

print("QAP results for weighted networks")
sum_mep_cor_w
```

\newpage

## D. Detailed ERGM analysis

### D.1 Structural effects

```{r echo=FALSE}
print("network ~ isolates")
summary(uw_net_soc_clim_100_nw ~ isolates)

print("network ~ degree(0:120)")
summary(uw_net_soc_clim_100_nw ~ degree(0:120))

print("network ~ kstar(0:120)")
summary(uw_net_soc_clim_100_nw ~ kstar(0:120))
```

\newpage

## E. Detailed ERGM results

### E.1 Model 0 (m0)

```{r echo=FALSE}
par(mfrow = c(2, 2))
plot(m0_fit)
par(mfrow = c(1, 1))
```

### E.2 Model 2.1 (m2_1)

```{r echo=FALSE}
par(mfrow = c(2, 2))
plot(m2_1_fit)
par(mfrow = c(1, 1))

invisible(capture.output(ergm::mcmc.diagnostics(m2_1, which = "plots")))
```

### E.3 Model 2.2 (m2_2)

```{r echo=FALSE}
par(mfrow = c(2, 2))
plot(m2_2_fit)
par(mfrow = c(1, 1))

invisible(capture.output(ergm::mcmc.diagnostics(m2_2, which = "plots")))
```

### E.4 Model 4 (m4)

```{r echo=FALSE}
par(mfrow = c(2, 2))
plot(m4_fit)
par(mfrow = c(1, 1))

invisible(capture.output(ergm::mcmc.diagnostics(m4, which = "plots")))
```

\newpage

## F. Coal & Steel Vote Document

https://www.europarl.europa.eu/doceo/document/A-9-2021-0102_EN.html

\newpage

## G. Impacts of Climate Change Document

https://www.europarl.europa.eu/doceo/document/A-9-2021-0115_EN.html

<!--
Sources of introduction:

 William P. Eveland Jr., Myiah J. Hutchens & Alyssa C. Morey (2013) Political Network Size and Its Antecedents and Consequences, Political Communication, 30:3, 371-394, DOI: 10.1080/10584609.2012.737433 
 
 Schneider, Volker & Lang, Achim & Leifeld, Philip & Gundelach, Birte. (2007). Political Networks - A Structured Bibliography. 

Lee, Jeongyoon. (2019). The Oxford handbook of political networks: edited by Jennifer Nicoll Victor, Alexander H. Montgomery and Mark Lubell, Oxford, New York, Oxford University Press, 2017, 1008 pp., $175.00 (hardback), ISBN: 9780190228217, DOI:10.1093/oxfordhb/9780190228217.001.0001. International Review of Public Administration. 24. 1-3. 10.1080/12294659.2019.1662655. 

Cherepnalkoski D, Karpf A, Mozetič I, Grčar M (2016) Cohesion and Coalition Formation in the European Parliament: Roll-Call Votes and Twitter Activities. PLoS ONE 11(11): e0166586. https://doi.org/10.1371/journal.pone.0166586

UNIVERSIDAD AUTONOMA DE BARCELONA (2021, 2026) A Network Science Approach to Social Cohesion in European Societies https://cordis.europa.eu/project/id/101020038

Sources of vulnerable populations:

Least developed countries expert group - United Nations Climate Change Secretariat (2018) Considerations regarding vulnerable groups, communities and ecosystems in the context of the national adaptiations plans https://unfccc.int/sites/default/files/resource/Considerations%20regarding%20vulnerable.pdf 

Nathanial Matthews, Deon Nel (2019) Climate change hits vulnerable communities first and hardest https://www.iisd.org/articles/climate-change-hits-vulnerable-communities-first-and-hardest 

Public health newswire American public health association (2021) Climate changes health: vulnerable populations https://www.apha.org/topics-and-issues/climate-change/vulnerable-populations 
-->
